<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="·ª®ng d·ª•ng t√≠nh ti·ªÅn ph√≤ng tr·ªç - ƒê∆°n gi·∫£n, nhanh ch√≥ng"
    />
    <title>T√≠nh Ti·ªÅn Ph√≤ng Tr·ªç</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#3b82f6",
              "primary-dark": "#2563eb",
            },
          },
        },
      };
    </script>
    <style>
      * {
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
      }

      .btn-primary {
        @apply bg-primary hover:bg-primary-dark active:scale-95 transition-all duration-150 text-white font-black py-7 px-10 rounded-2xl shadow-lg min-h-[90px] text-3xl;
      }

      .btn-secondary {
        @apply bg-green-500 hover:bg-green-600 active:scale-95 transition-all duration-150 text-white font-black py-7 px-10 rounded-2xl shadow-lg min-h-[90px] text-3xl;
      }

      .input-field {
        @apply w-full px-8 py-8 text-3xl border-4 border-gray-400 rounded-2xl focus:outline-none focus:ring-4 focus:ring-primary focus:border-primary bg-white text-gray-900 min-h-[100px] transition-all font-bold;
      }

      .input-field:focus {
        transform: scale(1.02);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
      }

      select.input-field {
        @apply py-7 min-h-[100px];
      }

      textarea.input-field {
        @apply py-6 min-h-[140px];
      }

      .label-text {
        @apply block text-2xl font-black text-gray-900 mb-4;
      }

      .card {
        @apply bg-white rounded-2xl shadow-lg p-8 mb-6 border border-gray-100;
      }

      .invoice-table {
        @apply w-full border-collapse;
      }

      .invoice-table th,
      .invoice-table td {
        @apply px-4 py-4 text-left border-b border-gray-200;
      }

      .invoice-table th {
        @apply font-bold text-gray-800 bg-gray-50;
      }

      .invoice-table td {
        @apply text-gray-900;
      }

      .modal {
        @apply fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50;
      }

      .modal-content {
        @apply bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto;
      }

      .grid-2 {
        @apply grid grid-cols-2 gap-3;
      }

      /* Mobile optimizations */
      @media (max-width: 640px) {
        .grid-2 {
          @apply gap-3;
        }

        .card {
          @apply p-4;
        }

        .invoice-table th,
        .invoice-table td {
          @apply px-2 py-2 text-sm;
        }

        .modal-content {
          @apply max-h-[85vh];
        }
      }

      /* Improve number input on mobile */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      input[type="number"] {
        -moz-appearance: textfield;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
      <!-- Header -->
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-3">
          üí∞ T√≠nh Ti·ªÅn Ph√≤ng Tr·ªç
        </h1>
        <p class="text-xl text-gray-600">ƒê∆°n gi·∫£n - Nhanh ch√≥ng - Ch√≠nh x√°c</p>
      </header>

      <!-- Settings Button -->
      <div class="mb-6">
        <button
          onclick="openSettings()"
          class="w-full bg-gray-200 hover:bg-gray-300 active:scale-95 transition-all duration-150 text-gray-800 font-bold py-5 px-8 rounded-xl min-h-[70px] shadow-sm text-xl"
        >
          ‚öôÔ∏è C√†i ƒê·∫∑t ƒê∆°n Gi√°
        </button>
      </div>

      <!-- Main Form -->
      <div class="card">
        <form id="rentalForm" onsubmit="calculateTotal(event)">
          <!-- Tenant Name -->
          <div class="mb-6">
            <label class="label-text">Ph√≤ng</label>
            <input
              type="text"
              id="tenantName"
              class="input-field"
              placeholder="Nh·∫≠p t√™n ph√≤ng"
              required
              autocomplete="off"
            />
          </div>

          <!-- Month Selection -->
          <div class="mb-6">
            <label class="label-text">Th√°ng T√≠nh Ti·ªÅn</label>
            <select id="billingMonth" class="input-field" required>
              <option value="">-- Ch·ªçn th√°ng --</option>
              <option value="1">Th√°ng 1</option>
              <option value="2">Th√°ng 2</option>
              <option value="3">Th√°ng 3</option>
              <option value="4">Th√°ng 4</option>
              <option value="5">Th√°ng 5</option>
              <option value="6">Th√°ng 6</option>
              <option value="7">Th√°ng 7</option>
              <option value="8">Th√°ng 8</option>
              <option value="9">Th√°ng 9</option>
              <option value="10">Th√°ng 10</option>
              <option value="11">Th√°ng 11</option>
              <option value="12">Th√°ng 12</option>
            </select>
          </div>

          <!-- Room Price -->
          <div class="mb-6">
            <label class="label-text">Ti·ªÅn Ph√≤ng (VNƒê)</label>
            <input
              type="number"
              id="roomPrice"
              class="input-field"
              placeholder="0"
              required
              min="0"
              inputmode="numeric"
              pattern="[0-9]*"
              autocomplete="off"
            />
          </div>

          <!-- Electricity -->
          <div class="mb-6">
            <label class="label-text">S·ªë ƒêi·ªán (kWh)</label>
            <div class="grid-2">
              <div>
                <label class="text-sm text-gray-600 mb-1 block">S·ªë c≈©</label>
                <input
                  type="number"
                  id="electricOld"
                  class="input-field"
                  placeholder="0"
                  required
                  min="0"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  oninput="calculateElectric()"
                  autocomplete="off"
                />
              </div>
              <div>
                <label class="text-sm text-gray-600 mb-1 block">S·ªë m·ªõi</label>
                <input
                  type="number"
                  id="electricNew"
                  class="input-field"
                  placeholder="0"
                  required
                  min="0"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  oninput="calculateElectric()"
                  autocomplete="off"
                />
              </div>
            </div>
            <p class="text-lg text-gray-600 mt-3 font-semibold">
              Ti√™u th·ª•:
              <span id="electricUsed" class="font-bold text-primary text-xl"
                >0</span
              >
              kWh
            </p>
          </div>

          <!-- Water -->
          <div class="mb-6">
            <label class="label-text">S·ªë N∆∞·ªõc (m¬≥)</label>
            <div class="grid-2">
              <div>
                <label class="text-sm text-gray-600 mb-1 block">S·ªë c≈©</label>
                <input
                  type="number"
                  id="waterOld"
                  class="input-field"
                  placeholder="0"
                  required
                  min="0"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  oninput="calculateWater()"
                  autocomplete="off"
                />
              </div>
              <div>
                <label class="text-sm text-gray-600 mb-1 block">S·ªë m·ªõi</label>
                <input
                  type="number"
                  id="waterNew"
                  class="input-field"
                  placeholder="0"
                  required
                  min="0"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  oninput="calculateWater()"
                  autocomplete="off"
                />
              </div>
            </div>
            <p class="text-lg text-gray-600 mt-3 font-semibold">
              Ti√™u th·ª•:
              <span id="waterUsed" class="font-bold text-primary text-xl"
                >0</span
              >
              m¬≥
            </p>
          </div>

          <!-- Other Fees -->
          <div class="mb-6">
            <label class="label-text">Chi Ph√≠ Kh√°c</label>
            <div class="grid-2">
              <div>
                <input
                  type="number"
                  id="otherFees"
                  class="input-field"
                  placeholder="S·ªë ti·ªÅn (VNƒê)"
                  value="0"
                  min="0"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  autocomplete="off"
                />
              </div>
              <div>
                <input
                  type="text"
                  id="otherFeesDesc"
                  class="input-field"
                  placeholder="M√¥ t·∫£ (VD: Wifi, r√°c...)"
                  autocomplete="off"
                />
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="mb-8">
            <label class="label-text">Ghi Ch√∫ (T√πy ch·ªçn)</label>
            <textarea
              id="notes"
              class="input-field"
              placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c√≥..."
              rows="3"
              autocomplete="off"
            ></textarea>
          </div>

          <!-- Action Buttons -->
          <div class="space-y-3">
            <button type="submit" class="btn-primary w-full">
              üìä Xu·∫•t H√≥a ƒê∆°n
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
      <div class="modal-content">
        <div class="p-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-8">
            ‚öôÔ∏è C√†i ƒê·∫∑t ƒê∆°n Gi√°
          </h2>

          <div class="mb-6">
            <label class="label-text">ƒê∆°n Gi√° ƒêi·ªán (VNƒê/kWh)</label>
            <input
              type="number"
              id="electricPrice"
              class="input-field text-center"
              placeholder="0"
              min="0"
              step="100"
              inputmode="numeric"
              pattern="[0-9]*"
              autocomplete="off"
            />
          </div>

          <div class="mb-8">
            <label class="label-text">ƒê∆°n Gi√° N∆∞·ªõc (VNƒê/m¬≥)</label>
            <input
              type="number"
              id="waterPrice"
              class="input-field text-center"
              placeholder="0"
              min="0"
              step="100"
              inputmode="numeric"
              pattern="[0-9]*"
              autocomplete="off"
            />
          </div>

          <div class="grid-2">
            <button onclick="saveSettings()" class="btn-primary">üíæ L∆∞u</button>
            <button
              onclick="closeSettings()"
              class="bg-gray-300 hover:bg-gray-400 active:scale-95 transition-all duration-150 text-gray-800 font-bold py-5 px-8 rounded-xl min-h-[70px] text-xl shadow-sm"
            >
              ‚ùå H·ªßy
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal hidden">
      <div class="modal-content">
        <div class="p-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">
            üßæ H√ìA ƒê∆†N TI·ªÄN PH√íNG
          </h2>

          <div id="invoiceContent"></div>

          <div class="mt-8 space-y-4">
            <button onclick="sendToZalo()" class="btn-secondary w-full">
              ÔøΩ G·ª≠i qua Zalo
            </button>
            <button
              onclick="closeInvoice()"
              class="bg-gray-300 hover:bg-gray-400 active:scale-95 transition-all duration-150 text-gray-800 font-bold py-5 px-8 rounded-xl w-full min-h-[70px] text-xl shadow-sm"
            >
              ‚ùå ƒê√≥ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Load settings from localStorage
      function loadSettings() {
        const electricPrice = localStorage.getItem("electricPrice") || "3500";
        const waterPrice = localStorage.getItem("waterPrice") || "20000";
        document.getElementById("electricPrice").value = electricPrice;
        document.getElementById("waterPrice").value = waterPrice;

        // Set current month as default
        const currentMonth = new Date().getMonth() + 1; // 0-11 -> 1-12
        document.getElementById("billingMonth").value = currentMonth;
      }

      // Save settings to localStorage
      function saveSettings() {
        const electricPrice = document.getElementById("electricPrice").value;
        const waterPrice = document.getElementById("waterPrice").value;

        if (!electricPrice || !waterPrice) {
          alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ƒë∆°n gi√°!");
          return;
        }

        localStorage.setItem("electricPrice", electricPrice);
        localStorage.setItem("waterPrice", waterPrice);
        closeSettings();
        alert("‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng!");
      }

      // Calculate electric usage
      function calculateElectric() {
        const oldValue =
          parseFloat(document.getElementById("electricOld").value) || 0;
        const newValue =
          parseFloat(document.getElementById("electricNew").value) || 0;
        const used = Math.max(0, newValue - oldValue);
        document.getElementById("electricUsed").textContent = used.toFixed(1);
      }

      // Calculate water usage
      function calculateWater() {
        const oldValue =
          parseFloat(document.getElementById("waterOld").value) || 0;
        const newValue =
          parseFloat(document.getElementById("waterNew").value) || 0;
        const used = Math.max(0, newValue - oldValue);
        document.getElementById("waterUsed").textContent = used.toFixed(1);
      }

      // Format currency
      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      }

      // Calculate total and show invoice
      function calculateTotal(event) {
        event.preventDefault();

        const tenantName = document.getElementById("tenantName").value;
        const billingMonth = document.getElementById("billingMonth").value;
        const roomPrice =
          parseFloat(document.getElementById("roomPrice").value) || 0;
        const electricOld =
          parseFloat(document.getElementById("electricOld").value) || 0;
        const electricNew =
          parseFloat(document.getElementById("electricNew").value) || 0;
        const waterOld =
          parseFloat(document.getElementById("waterOld").value) || 0;
        const waterNew =
          parseFloat(document.getElementById("waterNew").value) || 0;
        const otherFees =
          parseFloat(document.getElementById("otherFees").value) || 0;
        const otherFeesDesc = document.getElementById("otherFeesDesc").value;
        const notes = document.getElementById("notes").value;

        const electricPrice =
          parseFloat(localStorage.getItem("electricPrice")) || 3500;
        const waterPrice =
          parseFloat(localStorage.getItem("waterPrice")) || 20000;

        const electricUsed = Math.max(0, electricNew - electricOld);
        const waterUsed = Math.max(0, waterNew - waterOld);

        const electricCost = electricUsed * electricPrice;
        const waterCost = waterUsed * waterPrice;
        const total = roomPrice + electricCost + waterCost + otherFees;

        // Generate invoice HTML
        const invoiceHTML = `
                <div class="mb-6 text-center bg-gray-50 p-5 rounded-xl">
                    <p class="text-2xl font-bold text-gray-900">Ph√≤ng: ${tenantName}</p>
                    <p class="text-lg text-primary font-semibold mt-1">Th√°ng ${billingMonth}</p>
                    <p class="text-lg text-gray-600 mt-2">Ng√†y: ${new Date().toLocaleDateString(
                      "vi-VN"
                    )}</p>
                </div>

                <table class="invoice-table text-base">
                    <thead>
                        <tr>
                            <th class="text-base">Kho·∫£n</th>
                            <th class="text-right text-base">S·ªë l∆∞·ª£ng</th>
                            <th class="text-right text-base">ƒê∆°n gi√°</th>
                            <th class="text-right text-base">Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-semibold text-base">Ti·ªÅn ph√≤ng</td>
                            <td class="text-right text-base">-</td>
                            <td class="text-right text-base">${formatCurrency(
                              roomPrice
                            )}</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(
                              roomPrice
                            )}</td>
                        </tr>
                        <tr>
                            <td class="font-semibold text-base">ƒêi·ªán</td>
                            <td class="text-right text-base">${electricUsed.toFixed(
                              1
                            )} kWh</td>
                            <td class="text-right text-base">${formatCurrency(
                              electricPrice
                            )}</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(
                              electricCost
                            )}</td>
                        </tr>
                        <tr>
                            <td class="text-sm text-gray-500">Ch·ªâ s·ªë: ${electricOld} ‚Üí ${electricNew}</td>
                            <td colspan="3"></td>
                        </tr>
                        <tr>
                            <td class="font-semibold text-base">N∆∞·ªõc</td>
                            <td class="text-right text-base">${waterUsed.toFixed(
                              1
                            )} m¬≥</td>
                            <td class="text-right text-base">${formatCurrency(
                              waterPrice
                            )}</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(
                              waterCost
                            )}</td>
                        </tr>
                        <tr>
                            <td class="text-sm text-gray-500">Ch·ªâ s·ªë: ${waterOld} ‚Üí ${waterNew}</td>
                            <td colspan="3"></td>
                        </tr>
                        ${
                          otherFees > 0
                            ? `
                        <tr>
                            <td class="font-semibold text-base">Chi ph√≠ kh√°c${
                              otherFeesDesc ? ` (${otherFeesDesc})` : ""
                            }</td>
                            <td class="text-right text-base">-</td>
                            <td class="text-right text-base">-</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(
                              otherFees
                            )}</td>
                        </tr>
                        `
                            : ""
                        }
                    </tbody>
                    <tfoot>
                        <tr class="bg-primary text-white">
                            <td colspan="3" class="font-bold text-xl">T·ªîNG C·ªòNG</td>
                            <td class="text-right font-bold text-xl">${formatCurrency(
                              total
                            )}</td>
                        </tr>
                    </tfoot>
                </table>
                ${
                  notes
                    ? `
                <div class="mt-6 p-4 bg-yellow-50 rounded-xl border-l-4 border-yellow-400">
                    <p class="text-sm font-semibold text-yellow-800 mb-1">üìù Ghi ch√∫:</p>
                    <p class="text-base text-gray-700 whitespace-pre-wrap">${notes}</p>
                </div>
                `
                    : ""
                }
            `;

        document.getElementById("invoiceContent").innerHTML = invoiceHTML;

        // Store invoice data for Zalo
        window.currentInvoice = {
          tenantName,
          billingMonth,
          date: new Date().toLocaleDateString("vi-VN"),
          roomPrice,
          electricOld,
          electricNew,
          electricUsed,
          electricPrice,
          electricCost,
          waterOld,
          waterNew,
          waterUsed,
          waterPrice,
          waterCost,
          otherFees,
          otherFeesDesc,
          notes,
          total,
        };

        openInvoice();
      }

      // Send to Zalo
      async function sendToZalo() {
        const inv = window.currentInvoice;
        if (!inv) return;

        let message = `üßæ H√ìA ƒê∆†N TI·ªÄN PH√íNG\n`;
        message += `Th√°ng ${inv.billingMonth}\n`;
        message += `------------------------\n\n`;
        message += `üë§ Ph√≤ng: ${inv.tenantName}\n`;
        message += `üìÖ Ng√†y: ${inv.date}\n\n`;

        message += `üìã CHI TI·∫æT\n`;
        message += `------------------------\n\n`;

        message += `üè† Ti·ªÅn ph√≤ng\n`;
        message += `${formatCurrency(inv.roomPrice)}\n\n`;

        message += `‚ö° ƒêi·ªán: ${inv.electricUsed.toFixed(1)} kWh\n`;
        message += `Ch·ªâ s·ªë: ${inv.electricOld} ‚Üí ${inv.electricNew}\n`;
        message += `ƒê∆°n gi√°: ${formatCurrency(inv.electricPrice)}/kWh\n`;
        message += `Th√†nh ti·ªÅn: ${formatCurrency(inv.electricCost)}\n\n`;

        message += `üíß N∆∞·ªõc: ${inv.waterUsed.toFixed(1)} m¬≥\n`;
        message += `Ch·ªâ s·ªë: ${inv.waterOld} ‚Üí ${inv.waterNew}\n`;
        message += `ƒê∆°n gi√°: ${formatCurrency(inv.waterPrice)}/m¬≥\n`;
        message += `Th√†nh ti·ªÅn: ${formatCurrency(inv.waterCost)}\n\n`;

        if (inv.otherFees > 0) {
          message += `üìå Chi ph√≠ kh√°c${
            inv.otherFeesDesc ? ` (${inv.otherFeesDesc})` : ""
          }\n`;
          message += `${formatCurrency(inv.otherFees)}\n\n`;
        }

        message += `------------------------\n`;
        message += `üí∞ T·ªîNG C·ªòNG\n`;
        message += `${formatCurrency(inv.total)}\n`;
        message += `------------------------`;

        if (inv.notes) {
          message += `\n\nüìù Ghi ch√∫:\n${inv.notes}`;
        }

        // Try Web Share API first (works on mobile - shows native share dialog)
        if (navigator.share) {
          try {
            await navigator.share({
              title: "H√≥a ƒë∆°n ti·ªÅn ph√≤ng",
              text: message,
            });
            return; // Success - exit function
          } catch (err) {
            // User cancelled or share failed - continue to fallback
            if (err.name === "AbortError") {
              return; // User cancelled, don't show alert
            }
          }
        }

        // Fallback: Copy to clipboard and notify user
        try {
          await navigator.clipboard.writeText(message);
          alert("‚úÖ ƒê√£ copy h√≥a ƒë∆°n!\n\nM·ªü Zalo v√† paste (d√°n) ƒë·ªÉ g·ª≠i.");
        } catch (err) {
          // Fallback for older browsers
          const textarea = document.createElement("textarea");
          textarea.value = message;
          textarea.style.position = "fixed";
          textarea.style.opacity = "0";
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand("copy");
            alert("‚úÖ ƒê√£ copy h√≥a ƒë∆°n!\n\nM·ªü Zalo v√† paste (d√°n) ƒë·ªÉ g·ª≠i.");
          } catch (e) {
            alert(
              "‚ùå Kh√¥ng th·ªÉ copy t·ª± ƒë·ªông.\n\nVui l√≤ng copy n·ªôi dung h√≥a ƒë∆°n th·ªß c√¥ng."
            );
          }
          document.body.removeChild(textarea);
        }
      }

      // Modal functions
      function openSettings() {
        document.getElementById("settingsModal").classList.remove("hidden");
      }

      function closeSettings() {
        document.getElementById("settingsModal").classList.add("hidden");
      }

      function openInvoice() {
        document.getElementById("invoiceModal").classList.remove("hidden");
        // Auto scroll to bottom to see the modal
        setTimeout(() => {
          window.scrollTo({
            top: document.body.scrollHeight,
            behavior: "smooth",
          });
        }, 100);
      }

      function closeInvoice() {
        document.getElementById("invoiceModal").classList.add("hidden");
      }

      // Close modals when clicking outside
      document
        .getElementById("settingsModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeSettings();
        });

      document
        .getElementById("invoiceModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeInvoice();
        });

      // Initialize
      loadSettings();
    </script>
  </body>
</html>
