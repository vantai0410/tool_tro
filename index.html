<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="·ª®ng d·ª•ng t√≠nh ti·ªÅn ph√≤ng tr·ªç - ƒê∆°n gi·∫£n, nhanh ch√≥ng"
    />
    <title>T√≠nh Ti·ªÅn Ph√≤ng Tr·ªç</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css" />

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        orderBy,
        where,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyChFmvKZGMk5nMHsiqPdycVExzewhj0Dgg",
        authDomain: "toolhome-c693d.firebaseapp.com",
        projectId: "toolhome-c693d",
        storageBucket: "toolhome-c693d.firebasestorage.app",
        messagingSenderId: "918335077171",
        appId: "1:918335077171:web:8506327f75593dd88edc46",
        measurementId: "G-54HZHG5V5V",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // Make Firebase functions globally accessible
      window.db = db;
      window.firestoreFunctions = {
        collection,
        addDoc,
        getDocs,
        query,
        orderBy,
        where,
      };
    </script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#3b82f6",
              "primary-dark": "#2563eb",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
      <!-- Header -->
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-3">
          üí∞ T√≠nh Ti·ªÅn Ph√≤ng Tr·ªç
        </h1>
        <p class="text-xl text-gray-600">ƒê∆°n gi·∫£n - Nhanh ch√≥ng - Ch√≠nh x√°c</p>
      </header>

      <!-- Settings Button -->
      <div class="mb-6 grid grid-cols-2 gap-3">
        <button
          onclick="openSettings()"
          class="bg-gray-200 hover:bg-gray-300 active:scale-95 transition-all duration-150 text-gray-800 font-bold py-5 px-8 rounded-xl min-h-[70px] shadow-sm text-xl"
        >
          ‚öôÔ∏è C√†i ƒê·∫∑t
        </button>
        <button
          onclick="openHistory()"
          class="bg-purple-500 hover:bg-purple-600 active:scale-95 transition-all duration-150 text-white font-bold py-5 px-8 rounded-xl min-h-[70px] shadow-sm text-xl"
        >
          üìú L·ªãch S·ª≠
        </button>
      </div>

      <!-- Main Form -->
      <div class="card">
        <form id="rentalForm" onsubmit="calculateTotal(event)">
          <!-- Room Selection -->
          <div class="mb-6">
            <label class="label-text">Ph√≤ng</label>
            <select id="tenantName" class="input-field" required>
              <option value="">-- Ch·ªçn ph√≤ng --</option>
              <option value="P01">P01</option>
              <option value="P02">P02</option>
              <option value="P03">P03</option>
              <option value="P04">P04</option>
              <option value="P05">P05</option>
              <option value="P06">P06</option>
              <option value="P07">P07</option>
              <option value="P08">P08</option>
              <option value="P09">P09</option>
              <option value="P10">P10</option>
              <option value="P11">P11</option>
              <option value="P12">P12</option>
              <option value="P13">P13</option>
              <option value="P14">P14</option>
              <option value="P15">P15</option>
            </select>
          </div>

          <!-- Month Selection -->
          <div class="mb-6">
            <label class="label-text">Th√°ng T√≠nh Ti·ªÅn</label>
            <select id="billingMonth" class="input-field" required>
              <option value="">-- Ch·ªçn th√°ng --</option>
              <option value="1">Th√°ng 1</option>
              <option value="2">Th√°ng 2</option>
              <option value="3">Th√°ng 3</option>
              <option value="4">Th√°ng 4</option>
              <option value="5">Th√°ng 5</option>
              <option value="6">Th√°ng 6</option>
              <option value="7">Th√°ng 7</option>
              <option value="8">Th√°ng 8</option>
              <option value="9">Th√°ng 9</option>
              <option value="10">Th√°ng 10</option>
              <option value="11">Th√°ng 11</option>
              <option value="12">Th√°ng 12</option>
            </select>
          </div>

          <!-- Room Price -->
          <div class="mb-6">
            <label class="label-text">Ti·ªÅn Ph√≤ng (VNƒê)</label>
            <input
              type="number"
              id="roomPrice"
              class="input-field"
              placeholder="0"
              required
              min="0"
              inputmode="numeric"
              pattern="[0-9]*"
              autocomplete="off"
            />
          </div>

          <!-- Electricity -->
          <div class="mb-6">
            <label class="label-text">S·ªë ƒêi·ªán (kWh)</label>
            <div class="grid-2">
              <div>
                <label class="text-sm text-gray-600 mb-1 block">S·ªë c≈©</label>
                <input
                  type="number"
                  id="electricOld"
                  class="input-field"
                  placeholder="0"
                  required
                  min="0"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  oninput="calculateElectric()"
                  autocomplete="off"
                />
              </div>
              <div>
                <label class="text-sm text-gray-600 mb-1 block">S·ªë m·ªõi</label>
                <input
                  type="number"
                  id="electricNew"
                  class="input-field"
                  placeholder="0"
                  required
                  min="0"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  oninput="calculateElectric()"
                  autocomplete="off"
                />
              </div>
            </div>
            <p class="text-lg text-gray-600 mt-3 font-semibold">
              Ti√™u th·ª•:
              <span id="electricUsed" class="font-bold text-primary text-xl"
                >0</span
              >
              kWh
            </p>
          </div>

          <!-- Water -->
          <div class="mb-6">
            <label class="label-text">S·ªë N∆∞·ªõc (m¬≥)</label>
            <div class="grid-2">
              <div>
                <label class="text-sm text-gray-600 mb-1 block">S·ªë c≈©</label>
                <input
                  type="number"
                  id="waterOld"
                  class="input-field"
                  placeholder="0"
                  required
                  min="0"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  oninput="calculateWater()"
                  autocomplete="off"
                />
              </div>
              <div>
                <label class="text-sm text-gray-600 mb-1 block">S·ªë m·ªõi</label>
                <input
                  type="number"
                  id="waterNew"
                  class="input-field"
                  placeholder="0"
                  required
                  min="0"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  oninput="calculateWater()"
                  autocomplete="off"
                />
              </div>
            </div>
            <p class="text-lg text-gray-600 mt-3 font-semibold">
              Ti√™u th·ª•:
              <span id="waterUsed" class="font-bold text-primary text-xl"
                >0</span
              >
              m¬≥
            </p>
          </div>

          <!-- Other Fees -->
          <div class="mb-6">
            <label class="label-text">Chi Ph√≠ Kh√°c</label>
            <div class="grid-2">
              <div>
                <input
                  type="number"
                  id="otherFees"
                  class="input-field"
                  placeholder="S·ªë ti·ªÅn (VNƒê)"
                  value="0"
                  min="0"
                  inputmode="numeric"
                  pattern="[0-9]*"
                  autocomplete="off"
                />
              </div>
              <div>
                <input
                  type="text"
                  id="otherFeesDesc"
                  class="input-field"
                  placeholder="M√¥ t·∫£ (VD: Wifi, r√°c...)"
                  autocomplete="off"
                />
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="mb-8">
            <label class="label-text">Ghi Ch√∫ (T√πy ch·ªçn)</label>
            <textarea
              id="notes"
              class="input-field"
              placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c√≥..."
              rows="3"
              autocomplete="off"
            ></textarea>
          </div>

          <!-- Action Buttons -->
          <div class="space-y-3">
            <button type="submit" class="btn-primary w-full">
              üìä Xu·∫•t H√≥a ƒê∆°n
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
      <div class="modal-content">
        <div class="p-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-8">
            ‚öôÔ∏è C√†i ƒê·∫∑t ƒê∆°n Gi√°
          </h2>

          <div class="mb-6">
            <label class="label-text">ƒê∆°n Gi√° ƒêi·ªán (VNƒê/kWh)</label>
            <input
              type="number"
              id="electricPrice"
              class="input-field text-center"
              placeholder="0"
              min="0"
              step="100"
              inputmode="numeric"
              pattern="[0-9]*"
              autocomplete="off"
            />
          </div>

          <div class="mb-8">
            <label class="label-text">ƒê∆°n Gi√° N∆∞·ªõc (VNƒê/m¬≥)</label>
            <input
              type="number"
              id="waterPrice"
              class="input-field text-center"
              placeholder="0"
              min="0"
              step="100"
              inputmode="numeric"
              pattern="[0-9]*"
              autocomplete="off"
            />
          </div>

          <div class="grid-2">
            <button onclick="saveSettings()" class="btn-primary">üíæ L∆∞u</button>
            <button
              onclick="closeSettings()"
              class="bg-gray-300 hover:bg-gray-400 active:scale-95 transition-all duration-150 text-gray-800 font-bold py-5 px-8 rounded-xl min-h-[70px] text-xl shadow-sm"
            >
              ‚ùå H·ªßy
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal hidden">
      <div class="modal-content">
        <div class="p-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">
            üßæ H√ìA ƒê∆†N TI·ªÄN PH√íNG
          </h2>

          <div id="invoiceContent"></div>

          <div class="mt-8 space-y-4">
            <button onclick="sendToZalo()" class="btn-secondary w-full">
              üì§ G·ª≠i qua Zalo
            </button>
            <button
              onclick="closeInvoice()"
              class="bg-gray-300 hover:bg-gray-400 active:scale-95 transition-all duration-150 text-gray-800 font-bold py-5 px-8 rounded-xl w-full min-h-[70px] text-xl shadow-sm"
            >
              ‚ùå ƒê√≥ng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="modal hidden">
      <div class="modal-content">
        <div class="p-4 sm:p-8">
          <h2
            class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4 text-center"
          >
            üìä L·ªãch S·ª≠ H√≥a ƒê∆°n
          </h2>

          <!-- Search Filter -->
          <div class="mb-4 grid grid-cols-2 gap-2">
            <select
              id="filterRoom"
              class="px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
              onchange="filterHistory()"
            >
              <option value="">üè† T·∫•t c·∫£ ph√≤ng</option>
              <option value="P01">P01</option>
              <option value="P02">P02</option>
              <option value="P03">P03</option>
              <option value="P04">P04</option>
              <option value="P05">P05</option>
              <option value="P06">P06</option>
              <option value="P07">P07</option>
              <option value="P08">P08</option>
              <option value="P09">P09</option>
              <option value="P10">P10</option>
              <option value="P11">P11</option>
              <option value="P12">P12</option>
              <option value="P13">P13</option>
              <option value="P14">P14</option>
              <option value="P15">P15</option>
            </select>
            <select
              id="filterMonth"
              class="px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
              onchange="filterHistory()"
            >
              <option value="">üìÖ T·∫•t c·∫£ th√°ng</option>
              <option value="1">Th√°ng 1</option>
              <option value="2">Th√°ng 2</option>
              <option value="3">Th√°ng 3</option>
              <option value="4">Th√°ng 4</option>
              <option value="5">Th√°ng 5</option>
              <option value="6">Th√°ng 6</option>
              <option value="7">Th√°ng 7</option>
              <option value="8">Th√°ng 8</option>
              <option value="9">Th√°ng 9</option>
              <option value="10">Th√°ng 10</option>
              <option value="11">Th√°ng 11</option>
              <option value="12">Th√°ng 12</option>
            </select>
          </div>

          <!-- Excel-style Table -->
          <div class="table-container mb-4">
            <table id="historyTable" class="excel-table">
              <thead>
                <tr>
                  <th>Ph√≤ng</th>
                  <th>Th√°ng</th>
                  <th>Ti·ªÅn ph√≤ng</th>
                  <th>ƒêi·ªán (kWh)</th>
                  <th>Ti·ªÅn ƒëi·ªán</th>
                  <th>N∆∞·ªõc (m¬≥)</th>
                  <th>Ti·ªÅn n∆∞·ªõc</th>
                  <th>Kh√°c</th>
                  <th>T·ªïng c·ªông</th>
                  <th>Ng√†y t·∫°o</th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                <tr>
                  <td colspan="10" style="text-align: center; padding: 20px">
                    ƒêang t·∫£i...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <button
            onclick="closeHistory()"
            class="bg-gray-300 hover:bg-gray-400 active:scale-95 transition-all duration-150 text-gray-800 font-bold py-3 px-6 rounded-xl w-full text-base shadow-sm"
          >
            ‚ùå ƒê√≥ng
          </button>
        </div>
      </div>
    </div>

    <script>
      // Load settings from localStorage
      function loadSettings() {
        const electricPrice = localStorage.getItem("electricPrice") || "3500";
        const waterPrice = localStorage.getItem("waterPrice") || "7000";
        document.getElementById("electricPrice").value = electricPrice;
        document.getElementById("waterPrice").value = waterPrice;

        // Set current month as default
        const currentMonth = new Date().getMonth() + 1; // 0-11 -> 1-12
        document.getElementById("billingMonth").value = currentMonth;
      }

      // Save settings to localStorage
      function saveSettings() {
        const electricPrice = document.getElementById("electricPrice").value;
        const waterPrice = document.getElementById("waterPrice").value;

        if (!electricPrice || !waterPrice) {
          alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß ƒë∆°n gi√°!");
          return;
        }

        localStorage.setItem("electricPrice", electricPrice);
        localStorage.setItem("waterPrice", waterPrice);
        closeSettings();
        alert("‚úÖ ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng!");
      }

      // Calculate electric usage
      function calculateElectric() {
        const oldValue =
          parseFloat(document.getElementById("electricOld").value) || 0;
        const newValue =
          parseFloat(document.getElementById("electricNew").value) || 0;
        const used = Math.max(0, newValue - oldValue);
        document.getElementById("electricUsed").textContent = used.toFixed(1);
      }

      // Calculate water usage
      function calculateWater() {
        const oldValue =
          parseFloat(document.getElementById("waterOld").value) || 0;
        const newValue =
          parseFloat(document.getElementById("waterNew").value) || 0;
        const used = Math.max(0, newValue - oldValue);
        document.getElementById("waterUsed").textContent = used.toFixed(1);
      }

      // Format currency
      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      }

      // Calculate total and show invoice
      function calculateTotal(event) {
        event.preventDefault();

        const tenantName = document.getElementById("tenantName").value;
        const billingMonth = document.getElementById("billingMonth").value;
        const roomPrice =
          parseFloat(document.getElementById("roomPrice").value) || 0;
        const electricOld =
          parseFloat(document.getElementById("electricOld").value) || 0;
        const electricNew =
          parseFloat(document.getElementById("electricNew").value) || 0;
        const waterOld =
          parseFloat(document.getElementById("waterOld").value) || 0;
        const waterNew =
          parseFloat(document.getElementById("waterNew").value) || 0;
        const otherFees =
          parseFloat(document.getElementById("otherFees").value) || 0;
        const otherFeesDesc = document.getElementById("otherFeesDesc").value;
        const notes = document.getElementById("notes").value;

        const electricPrice =
          parseFloat(localStorage.getItem("electricPrice")) || 3500;
        const waterPrice =
          parseFloat(localStorage.getItem("waterPrice")) || 7000;

        const electricUsed = Math.max(0, electricNew - electricOld);
        const waterUsed = Math.max(0, waterNew - waterOld);

        const electricCost = electricUsed * electricPrice;
        const waterCost = waterUsed * waterPrice;
        const total = roomPrice + electricCost + waterCost + otherFees;

        // Generate invoice HTML
        const invoiceHTML = `
                <div class="mb-6 text-center bg-gray-50 p-5 rounded-xl">
                    <p class="text-2xl font-bold text-gray-900">Ph√≤ng: ${tenantName}</p>
                    <p class="text-lg text-primary font-semibold mt-1">Th√°ng ${billingMonth}</p>
                    <p class="text-lg text-gray-600 mt-2">Ng√†y: ${new Date().toLocaleDateString(
                      "vi-VN",
                    )}</p>
                </div>

                <table class="invoice-table text-base">
                    <thead>
                        <tr>
                            <th class="text-base">Kho·∫£n</th>
                            <th class="text-right text-base">S·ªë l∆∞·ª£ng</th>
                            <th class="text-right text-base">ƒê∆°n gi√°</th>
                            <th class="text-right text-base">Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-semibold text-base">Ti·ªÅn ph√≤ng</td>
                            <td class="text-right text-base">-</td>
                            <td class="text-right text-base">${formatCurrency(
                              roomPrice,
                            )}</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(
                              roomPrice,
                            )}</td>
                        </tr>
                        <tr>
                            <td class="font-semibold text-base">ƒêi·ªán</td>
                            <td class="text-right text-base">${electricUsed.toFixed(
                              1,
                            )} kWh</td>
                            <td class="text-right text-base">${formatCurrency(
                              electricPrice,
                            )}</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(
                              electricCost,
                            )}</td>
                        </tr>
                        <tr>
                            <td class="text-sm text-gray-500">Ch·ªâ s·ªë: ${electricOld} ‚Üí ${electricNew}</td>
                            <td colspan="3"></td>
                        </tr>
                        <tr>
                            <td class="font-semibold text-base">N∆∞·ªõc</td>
                            <td class="text-right text-base">${waterUsed.toFixed(
                              1,
                            )} m¬≥</td>
                            <td class="text-right text-base">${formatCurrency(
                              waterPrice,
                            )}</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(
                              waterCost,
                            )}</td>
                        </tr>
                        <tr>
                            <td class="text-sm text-gray-500">Ch·ªâ s·ªë: ${waterOld} ‚Üí ${waterNew}</td>
                            <td colspan="3"></td>
                        </tr>
                        ${
                          otherFees > 0
                            ? `
                        <tr>
                            <td class="font-semibold text-base">Chi ph√≠ kh√°c${
                              otherFeesDesc ? ` (${otherFeesDesc})` : ""
                            }</td>
                            <td class="text-right text-base">-</td>
                            <td class="text-right text-base">-</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(
                              otherFees,
                            )}</td>
                        </tr>
                        `
                            : ""
                        }
                    </tbody>
                    <tfoot>
                        <tr class="bg-primary text-white">
                            <td colspan="3" class="font-bold text-xl">T·ªîNG C·ªòNG</td>
                            <td class="text-right font-bold text-xl">${formatCurrency(
                              total,
                            )}</td>
                        </tr>
                    </tfoot>
                </table>
                ${
                  notes
                    ? `
                <div class="mt-6 p-4 bg-yellow-50 rounded-xl border-l-4 border-yellow-400">
                    <p class="text-sm font-semibold text-yellow-800 mb-1">üìù Ghi ch√∫:</p>
                    <p class="text-base text-gray-700 whitespace-pre-wrap">${notes}</p>
                </div>
                `
                    : ""
                }
            `;

        document.getElementById("invoiceContent").innerHTML = invoiceHTML;

        // Store invoice data for Zalo
        window.currentInvoice = {
          tenantName,
          billingMonth,
          date: new Date().toLocaleDateString("vi-VN"),
          roomPrice,
          electricOld,
          electricNew,
          electricUsed,
          electricPrice,
          electricCost,
          waterOld,
          waterNew,
          waterUsed,
          waterPrice,
          waterCost,
          otherFees,
          otherFeesDesc,
          notes,
          total,
        };

        // Save invoice to Firebase
        saveInvoiceToFirebase(window.currentInvoice);

        openInvoice();
      }

      // Save invoice to Firebase Firestore
      async function saveInvoiceToFirebase(invoiceData) {
        try {
          // Check if Firebase is initialized
          if (!window.db || !window.firestoreFunctions) {
            throw new Error("Firebase ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o");
          }

          const { collection, addDoc } = window.firestoreFunctions;
          const invoiceWithTimestamp = {
            ...invoiceData,
            createdAt: new Date().toISOString(),
            year: new Date().getFullYear(),
          };

          console.log(
            "üì§ ƒêang l∆∞u h√≥a ƒë∆°n v√†o Firebase...",
            invoiceWithTimestamp,
          );

          const docRef = await addDoc(
            collection(window.db, "invoices"),
            invoiceWithTimestamp,
          );

          console.log("‚úÖ ƒê√£ l∆∞u h√≥a ƒë∆°n v√†o Firebase v·ªõi ID:", docRef.id);

          // Show success notification
          const successMsg = document.createElement("div");
          successMsg.innerHTML = "‚úÖ ƒê√£ l∆∞u v√†o Firebase";
          successMsg.style.cssText =
            "position:fixed;top:20px;right:20px;background:#10b981;color:white;padding:12px 20px;border-radius:8px;z-index:9999;font-weight:bold;box-shadow:0 4px 6px rgba(0,0,0,0.1);";
          document.body.appendChild(successMsg);
          setTimeout(() => successMsg.remove(), 3000);
        } catch (error) {
          console.error("‚ùå L·ªói khi l∆∞u h√≥a ƒë∆°n:", error);
          console.error("Chi ti·∫øt l·ªói:", error.message);

          // Show error notification
          alert(
            "‚ö†Ô∏è Kh√¥ng th·ªÉ l∆∞u h√≥a ƒë∆°n v√†o Firebase!\n\n" +
              "L·ªói: " +
              error.message +
              "\n\n" +
              "Vui l√≤ng ki·ªÉm tra:\n" +
              "1. ƒê√£ k√≠ch ho·∫°t Firestore Database ch∆∞a?\n" +
              "2. ƒê√£ c√†i ƒë·∫∑t Security Rules ch∆∞a?\n" +
              "3. C√≥ k·∫øt n·ªëi internet kh√¥ng?\n\n" +
              "Xem Console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt.",
          );
        }
      }

      // Load history from Firebase
      async function loadHistory() {
        try {
          const { collection, getDocs, query, orderBy } =
            window.firestoreFunctions;
          const q = query(
            collection(window.db, "invoices"),
            orderBy("createdAt", "desc"),
          );
          const querySnapshot = await getDocs(q);

          window.allInvoices = [];
          querySnapshot.forEach((doc) => {
            window.allInvoices.push({ id: doc.id, ...doc.data() });
          });

          displayHistory(window.allInvoices);
        } catch (error) {
          console.error("‚ùå L·ªói khi t·∫£i l·ªãch s·ª≠:", error);
          document.getElementById("historyList").innerHTML =
            '<p class="text-center text-red-500 py-8">‚ùå Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.</p>';
        }
      }

      // Display history list
      function displayHistory(invoices) {
        const historyTableBody = document.getElementById("historyTableBody");

        if (invoices.length === 0) {
          historyTableBody.innerHTML =
            '<tr><td colspan="10" style="text-align: center; padding: 20px;">Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o</td></tr>';
          return;
        }

        historyTableBody.innerHTML = invoices
          .map(
            (inv) => `
          <tr onclick="viewInvoiceFromHistory('${inv.id}')">
            <td><strong>${inv.tenantName}</strong></td>
            <td>${inv.billingMonth}/${inv.year || new Date().getFullYear()}</td>
            <td style="text-align: right;">${formatCurrency(inv.roomPrice)}</td>
            <td style="text-align: right;">${inv.electricUsed.toFixed(1)}</td>
            <td style="text-align: right;">${formatCurrency(inv.electricCost)}</td>
            <td style="text-align: right;">${inv.waterUsed.toFixed(1)}</td>
            <td style="text-align: right;">${formatCurrency(inv.waterCost)}</td>
            <td style="text-align: right;">${inv.otherFees > 0 ? formatCurrency(inv.otherFees) : "-"}</td>
            <td style="text-align: right; font-weight: bold; color: #3b82f6;">${formatCurrency(inv.total)}</td>
            <td style="font-size: 11px;">${new Date(inv.createdAt).toLocaleDateString("vi-VN")}</td>
          </tr>
        `,
          )
          .join("");
      }

      // Filter history
      function filterHistory() {
        const filterRoom = document.getElementById("filterRoom").value;
        const filterMonth = document.getElementById("filterMonth").value;

        let filtered = window.allInvoices || [];

        if (filterRoom) {
          filtered = filtered.filter((inv) => inv.tenantName === filterRoom);
        }

        if (filterMonth) {
          filtered = filtered.filter(
            (inv) => inv.billingMonth.toString() === filterMonth,
          );
        }

        displayHistory(filtered);
      }

      // View invoice from history
      function viewInvoiceFromHistory(invoiceId) {
        const invoice = window.allInvoices.find((inv) => inv.id === invoiceId);
        if (!invoice) return;

        window.currentInvoice = invoice;

        // Generate invoice HTML
        const inv = invoice;
        const invoiceHTML = `
                <div class="mb-6 text-center bg-gray-50 p-5 rounded-xl">
                    <p class="text-2xl font-bold text-gray-900">Ph√≤ng: ${inv.tenantName}</p>
                    <p class="text-lg text-primary font-semibold mt-1">Th√°ng ${inv.billingMonth}/${inv.year || new Date().getFullYear()}</p>
                    <p class="text-lg text-gray-600 mt-2">Ng√†y: ${inv.date}</p>
                    <p class="text-sm text-gray-400 mt-1">T·∫°o l√∫c: ${new Date(inv.createdAt).toLocaleString("vi-VN")}</p>
                </div>

                <table class="invoice-table text-base">
                    <thead>
                        <tr>
                            <th class="text-base">Kho·∫£n</th>
                            <th class="text-right text-base">S·ªë l∆∞·ª£ng</th>
                            <th class="text-right text-base">ƒê∆°n gi√°</th>
                            <th class="text-right text-base">Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-semibold text-base">Ti·ªÅn ph√≤ng</td>
                            <td class="text-right text-base">-</td>
                            <td class="text-right text-base">${formatCurrency(inv.roomPrice)}</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(inv.roomPrice)}</td>
                        </tr>
                        <tr>
                            <td class="font-semibold text-base">ƒêi·ªán</td>
                            <td class="text-right text-base">${inv.electricUsed.toFixed(1)} kWh</td>
                            <td class="text-right text-base">${formatCurrency(inv.electricPrice)}</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(inv.electricCost)}</td>
                        </tr>
                        <tr>
                            <td class="text-sm text-gray-500">Ch·ªâ s·ªë: ${inv.electricOld} ‚Üí ${inv.electricNew}</td>
                            <td colspan="3"></td>
                        </tr>
                        <tr>
                            <td class="font-semibold text-base">N∆∞·ªõc</td>
                            <td class="text-right text-base">${inv.waterUsed.toFixed(1)} m¬≥</td>
                            <td class="text-right text-base">${formatCurrency(inv.waterPrice)}</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(inv.waterCost)}</td>
                        </tr>
                        <tr>
                            <td class="text-sm text-gray-500">Ch·ªâ s·ªë: ${inv.waterOld} ‚Üí ${inv.waterNew}</td>
                            <td colspan="3"></td>
                        </tr>
                        ${
                          inv.otherFees > 0
                            ? `
                        <tr>
                            <td class="font-semibold text-base">Chi ph√≠ kh√°c${
                              inv.otherFeesDesc ? ` (${inv.otherFeesDesc})` : ""
                            }</td>
                            <td class="text-right text-base">-</td>
                            <td class="text-right text-base">-</td>
                            <td class="text-right font-bold text-primary text-lg">${formatCurrency(inv.otherFees)}</td>
                        </tr>
                        `
                            : ""
                        }
                    </tbody>
                    <tfoot>
                        <tr class="bg-primary text-white">
                            <td colspan="3" class="font-bold text-xl">T·ªîNG C·ªòNG</td>
                            <td class="text-right font-bold text-xl">${formatCurrency(inv.total)}</td>
                        </tr>
                    </tfoot>
                </table>
                ${
                  inv.notes
                    ? `
                <div class="mt-6 p-4 bg-yellow-50 rounded-xl border-l-4 border-yellow-400">
                    <p class="text-sm font-semibold text-yellow-800 mb-1">üìù Ghi ch√∫:</p>
                    <p class="text-base text-gray-700 whitespace-pre-wrap">${inv.notes}</p>
                </div>
                `
                    : ""
                }
            `;

        document.getElementById("invoiceContent").innerHTML = invoiceHTML;
        closeHistory();
        openInvoice();
      }

      // Send to Zalo
      async function sendToZalo() {
        const inv = window.currentInvoice;
        if (!inv) return;

        let message = `üßæ H√ìA ƒê∆†N TI·ªÄN PH√íNG\n`;
        message += `Th√°ng ${inv.billingMonth}\n`;
        message += `------------------------\n\n`;
        message += `üë§ Ph√≤ng: ${inv.tenantName}\n`;
        message += `üìÖ Ng√†y: ${inv.date}\n\n`;

        message += `üìã CHI TI·∫æT\n`;
        message += `------------------------\n\n`;

        message += `üè† Ti·ªÅn ph√≤ng\n`;
        message += `${formatCurrency(inv.roomPrice)}\n\n`;

        message += `‚ö° ƒêi·ªán: ${inv.electricUsed.toFixed(1)} kWh\n`;
        message += `Ch·ªâ s·ªë: ${inv.electricOld} ‚Üí ${inv.electricNew}\n`;
        message += `ƒê∆°n gi√°: ${formatCurrency(inv.electricPrice)}/kWh\n`;
        message += `Th√†nh ti·ªÅn: ${formatCurrency(inv.electricCost)}\n\n`;

        message += `üíß N∆∞·ªõc: ${inv.waterUsed.toFixed(1)} m¬≥\n`;
        message += `Ch·ªâ s·ªë: ${inv.waterOld} ‚Üí ${inv.waterNew}\n`;
        message += `ƒê∆°n gi√°: ${formatCurrency(inv.waterPrice)}/m¬≥\n`;
        message += `Th√†nh ti·ªÅn: ${formatCurrency(inv.waterCost)}\n\n`;

        if (inv.otherFees > 0) {
          message += `üìå Chi ph√≠ kh√°c${
            inv.otherFeesDesc ? ` (${inv.otherFeesDesc})` : ""
          }\n`;
          message += `${formatCurrency(inv.otherFees)}\n\n`;
        }

        message += `------------------------\n`;
        message += `üí∞ T·ªîNG C·ªòNG\n`;
        message += `${formatCurrency(inv.total)}\n`;
        message += `------------------------`;

        if (inv.notes) {
          message += `\n\nüìù Ghi ch√∫:\n${inv.notes}`;
        }

        // Try Web Share API first (works on mobile - shows native share dialog)
        if (navigator.share) {
          try {
            await navigator.share({
              title: "H√≥a ƒë∆°n ti·ªÅn ph√≤ng",
              text: message,
            });
            return; // Success - exit function
          } catch (err) {
            // User cancelled or share failed - continue to fallback
            if (err.name === "AbortError") {
              return; // User cancelled, don't show alert
            }
          }
        }

        // Fallback: Copy to clipboard and notify user
        try {
          await navigator.clipboard.writeText(message);
          alert("‚úÖ ƒê√£ copy h√≥a ƒë∆°n!\n\nM·ªü Zalo v√† paste (d√°n) ƒë·ªÉ g·ª≠i.");
        } catch (err) {
          // Fallback for older browsers
          const textarea = document.createElement("textarea");
          textarea.value = message;
          textarea.style.position = "fixed";
          textarea.style.opacity = "0";
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand("copy");
            alert("‚úÖ ƒê√£ copy h√≥a ƒë∆°n!\n\nM·ªü Zalo v√† paste (d√°n) ƒë·ªÉ g·ª≠i.");
          } catch (e) {
            alert(
              "‚ùå Kh√¥ng th·ªÉ copy t·ª± ƒë·ªông.\n\nVui l√≤ng copy n·ªôi dung h√≥a ƒë∆°n th·ªß c√¥ng.",
            );
          }
          document.body.removeChild(textarea);
        }
      }

      // Modal functions
      function openSettings() {
        document.getElementById("settingsModal").classList.remove("hidden");
      }

      function closeSettings() {
        document.getElementById("settingsModal").classList.add("hidden");
      }

      function openInvoice() {
        document.getElementById("invoiceModal").classList.remove("hidden");
        // Auto scroll to bottom to see the modal
        setTimeout(() => {
          window.scrollTo({
            top: document.body.scrollHeight,
            behavior: "smooth",
          });
        }, 100);
      }

      function closeInvoice() {
        document.getElementById("invoiceModal").classList.add("hidden");
      }

      function openHistory() {
        document.getElementById("historyModal").classList.remove("hidden");
        loadHistory();
      }

      function closeHistory() {
        document.getElementById("historyModal").classList.add("hidden");
        // Reset filters
        document.getElementById("filterRoom").value = "";
        document.getElementById("filterMonth").value = "";
      }

      // Close modals when clicking outside
      document
        .getElementById("settingsModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeSettings();
        });

      document
        .getElementById("invoiceModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeInvoice();
        });

      document
        .getElementById("historyModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeHistory();
        });

      // Initialize
      loadSettings();
    </script>
  </body>
</html>
